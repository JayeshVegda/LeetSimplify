name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate manifest.json
        run: |
          # Check if manifest.json exists and is valid JSON
          if [ ! -f manifest.json ]; then
            echo "Error: manifest.json not found"
            exit 1
          fi
          # Validate JSON syntax
          python3 -m json.tool manifest.json > /dev/null
          echo "✓ manifest.json is valid JSON"
      
      - name: Validate prompts.json
        run: |
          # Check if prompts.json exists and is valid JSON
          if [ ! -f prompts.json ]; then
            echo "Error: prompts.json not found"
            exit 1
          fi
          # Validate JSON syntax
          python3 -m json.tool prompts.json > /dev/null
          echo "✓ prompts.json is valid JSON"
      
      - name: Check required files
        run: |
          required_files=("content.js" "providers.js" "manifest.json" "prompts.json" "README.md" "LICENSE")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file $file not found"
              exit 1
            fi
          done
          echo "✓ All required files present"
      
      - name: Check file permissions
        run: |
          # Check if extension files have correct structure
          if [ ! -d "ui" ]; then
            echo "Error: ui directory not found"
            exit 1
          fi
          if [ ! -d "icons" ]; then
            echo "Error: icons directory not found"
            exit 1
          fi
          echo "✓ Directory structure is correct"
      
      - name: Validate manifest version
        run: |
          version=$(python3 -c "import json; print(json.load(open('manifest.json'))['version'])")
          if [ -z "$version" ]; then
            echo "Error: Version not found in manifest.json"
            exit 1
          fi
          echo "✓ Manifest version: $version"
      
      - name: Check for common issues
        run: |
          # Check for console.log statements (should use [LeetSimplify] prefix)
          if [ -f content.js ] || [ -f providers.js ] || [ -f ui/popup.js ]; then
            UNTAGGED_LOGS=""
            for file in content.js providers.js ui/popup.js; do
              if [ -f "$file" ]; then
                LOGS=$(grep "console\.log" "$file" 2>/dev/null | grep -v "\[LeetSimplify\]" || true)
                if [ -n "$LOGS" ]; then
                  UNTAGGED_LOGS="${UNTAGGED_LOGS}${LOGS}"$'\n'
                fi
              fi
            done
            if [ -n "$UNTAGGED_LOGS" ]; then
              echo "Warning: Found console.log without [LeetSimplify] prefix"
              echo "$UNTAGGED_LOGS"
            else
              echo "✓ No untagged console.log statements"
            fi
          else
            echo "✓ No JavaScript files to check"
          fi
          
          # Check for hardcoded API keys in code
          HARDCODED_KEYS=""
          for file in content.js providers.js ui/popup.js; do
            if [ -f "$file" ]; then
              KEYS=$(grep -i "api.*key.*=.*['\"].*[a-zA-Z0-9]\{20,\}" "$file" 2>/dev/null | grep -v "getItem\|localStorage\|sessionStorage\|chrome.storage" || true)
              if [ -n "$KEYS" ]; then
                HARDCODED_KEYS="${HARDCODED_KEYS}${KEYS}"$'\n'
              fi
            fi
          done
          if [ -n "$HARDCODED_KEYS" ]; then
            echo "Warning: Potential hardcoded API key found in code"
            echo "$HARDCODED_KEYS"
          else
            echo "✓ No hardcoded API keys detected"
          fi

  security:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for sensitive data
        run: |
          # Check for potential secrets in JavaScript and HTML files only
          # Exclude markdown, JSON configs, and documentation files
          
          FOUND_SECRETS=0
          
          # Check JavaScript files for API keys
          for file in $(find . -name "*.js" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.github/*"); do
            # Skip if file doesn't exist
            [ ! -f "$file" ] && continue
            
            # Check for OpenAI API keys (pattern: sk-proj- or sk- followed by alphanumeric)
            if grep -q "sk-[a-zA-Z0-9]\{32,\}" "$file" 2>/dev/null; then
              # Check if it's in a comment or string literal
              LINE=$(grep "sk-[a-zA-Z0-9]\{32,\}" "$file" | head -1)
              if echo "$LINE" | grep -qvE "(//|\*|<!--|example|sample|test|TODO|FIXME|'|\")"; then
                echo "Error: Potential OpenAI API key found in $file"
                echo "$LINE"
                FOUND_SECRETS=1
              fi
            fi
            
            # Check for Google API keys (pattern: AIza followed by 35+ chars)
            if grep -q "AIza[a-zA-Z0-9_-]\{35,\}" "$file" 2>/dev/null; then
              LINE=$(grep "AIza[a-zA-Z0-9_-]\{35,\}" "$file" | head -1)
              if echo "$LINE" | grep -qvE "(//|\*|<!--|example|sample|test|TODO|FIXME|'|\")"; then
                echo "Error: Potential Google API key found in $file"
                echo "$LINE"
                FOUND_SECRETS=1
              fi
            fi
          done
          
          # Check HTML files for API keys
          for file in $(find . -name "*.html" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.github/*"); do
            [ ! -f "$file" ] && continue
            
            if grep -q "sk-[a-zA-Z0-9]\{32,\}" "$file" 2>/dev/null; then
              LINE=$(grep "sk-[a-zA-Z0-9]\{32,\}" "$file" | head -1)
              if echo "$LINE" | grep -qvE "(<!--|example|sample|test|TODO|FIXME)"; then
                echo "Error: Potential API key found in $file"
                echo "$LINE"
                FOUND_SECRETS=1
              fi
            fi
          done
          
          if [ $FOUND_SECRETS -eq 0 ]; then
            echo "✓ No sensitive data detected in code files"
          else
            echo "::error::Sensitive data detected. Please remove API keys from code."
            exit 1
          fi

  build:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create extension package
        run: |
          # Create a ZIP file to verify all files are present
          zip -r leetsimplify-check.zip . -x "*.git*" -x "*.md" -x ".github/*" -x "*.zip"
          ls -lh leetsimplify-check.zip
          echo "✓ Extension package created successfully"
      
      - name: Verify package contents
        run: |
          unzip -l leetsimplify-check.zip | grep -E "(manifest.json|content.js|providers.js)" || exit 1
          echo "✓ Package contains required files"

