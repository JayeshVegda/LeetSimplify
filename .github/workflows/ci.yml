name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate manifest.json
        run: |
          # Check if manifest.json exists and is valid JSON
          if [ ! -f manifest.json ]; then
            echo "Error: manifest.json not found"
            exit 1
          fi
          # Validate JSON syntax
          python3 -m json.tool manifest.json > /dev/null
          echo "✓ manifest.json is valid JSON"
      
      - name: Validate prompts.json
        run: |
          # Check if prompts.json exists and is valid JSON
          if [ ! -f prompts.json ]; then
            echo "Error: prompts.json not found"
            exit 1
          fi
          # Validate JSON syntax
          python3 -m json.tool prompts.json > /dev/null
          echo "✓ prompts.json is valid JSON"
      
      - name: Check required files
        run: |
          required_files=("content.js" "providers.js" "manifest.json" "prompts.json" "README.md" "LICENSE")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file $file not found"
              exit 1
            fi
          done
          echo "✓ All required files present"
      
      - name: Check file permissions
        run: |
          # Check if extension files have correct structure
          if [ ! -d "ui" ]; then
            echo "Error: ui directory not found"
            exit 1
          fi
          if [ ! -d "icons" ]; then
            echo "Error: icons directory not found"
            exit 1
          fi
          echo "✓ Directory structure is correct"
      
      - name: Validate manifest version
        run: |
          version=$(python3 -c "import json; print(json.load(open('manifest.json'))['version'])")
          if [ -z "$version" ]; then
            echo "Error: Version not found in manifest.json"
            exit 1
          fi
          echo "✓ Manifest version: $version"
      
      - name: Check for common issues
        run: |
          # Check for console.log statements (should use [LeetSimplify] prefix)
          if [ -f content.js ] || [ -f providers.js ] || [ -f ui/popup.js ]; then
            UNTAGGED_LOGS=""
            for file in content.js providers.js ui/popup.js; do
              if [ -f "$file" ]; then
                LOGS=$(grep "console\.log" "$file" 2>/dev/null | grep -v "\[LeetSimplify\]" || true)
                if [ -n "$LOGS" ]; then
                  UNTAGGED_LOGS="${UNTAGGED_LOGS}${LOGS}"$'\n'
                fi
              fi
            done
            if [ -n "$UNTAGGED_LOGS" ]; then
              echo "Warning: Found console.log without [LeetSimplify] prefix"
              echo "$UNTAGGED_LOGS"
            else
              echo "✓ No untagged console.log statements"
            fi
          else
            echo "✓ No JavaScript files to check"
          fi
          
          # Check for hardcoded API keys in code
          HARDCODED_KEYS=""
          for file in content.js providers.js ui/popup.js; do
            if [ -f "$file" ]; then
              KEYS=$(grep -i "api.*key.*=.*['\"].*[a-zA-Z0-9]\{20,\}" "$file" 2>/dev/null | grep -v "getItem\|localStorage\|sessionStorage\|chrome.storage" || true)
              if [ -n "$KEYS" ]; then
                HARDCODED_KEYS="${HARDCODED_KEYS}${KEYS}"$'\n'
              fi
            fi
          done
          if [ -n "$HARDCODED_KEYS" ]; then
            echo "Warning: Potential hardcoded API key found in code"
            echo "$HARDCODED_KEYS"
          else
            echo "✓ No hardcoded API keys detected"
          fi

  security:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for sensitive data
        run: |
          # Check for potential secrets in JavaScript and HTML files only
          # Only check for actual API key patterns (long strings that look like real keys)
          
          FOUND_SECRETS=0
          
          # Check JavaScript files for API keys (only in actual code, not comments)
          for file in content.js providers.js ui/popup.js; do
            if [ ! -f "$file" ]; then
              continue
            fi
            
            # Check for OpenAI API keys: sk- followed by at least 48 characters (actual keys are longer)
            # Pattern: sk-proj-... or sk-... (OpenAI keys are typically 51+ chars)
            if grep -qE "sk-(proj-)?[a-zA-Z0-9]{48,}" "$file" 2>/dev/null; then
              # Get the line and check if it's in a comment
              LINE=$(grep -E "sk-(proj-)?[a-zA-Z0-9]{48,}" "$file" | head -1)
              # Skip if it's clearly in a comment, string, or documentation
              if echo "$LINE" | grep -qvE "(//|\*|/\*|\*/|<!--|-->|example|sample|test|TODO|FIXME|'sk-|\"sk-|`sk-)"; then
                echo "Error: Potential OpenAI API key found in $file"
                echo "Line: $LINE"
                FOUND_SECRETS=1
              fi
            fi
            
            # Check for Google API keys: AIza followed by exactly 35 characters (Google key format)
            if grep -qE "AIza[0-9A-Za-z_-]{35}" "$file" 2>/dev/null; then
              LINE=$(grep -E "AIza[0-9A-Za-z_-]{35}" "$file" | head -1)
              if echo "$LINE" | grep -qvE "(//|\*|/\*|\*/|<!--|-->|example|sample|test|TODO|FIXME|'AIza|\"AIza|`AIza)"; then
                echo "Error: Potential Google API key found in $file"
                echo "Line: $LINE"
                FOUND_SECRETS=1
              fi
            fi
            
            # Check for Anthropic API keys: sk-ant- followed by long string
            if grep -qE "sk-ant-[a-zA-Z0-9_-]{95,}" "$file" 2>/dev/null; then
              LINE=$(grep -E "sk-ant-[a-zA-Z0-9_-]{95,}" "$file" | head -1)
              if echo "$LINE" | grep -qvE "(//|\*|/\*|\*/|<!--|-->|example|sample|test|TODO|FIXME|'sk-ant-|\"sk-ant-|`sk-ant-)"; then
                echo "Error: Potential Anthropic API key found in $file"
                echo "Line: $LINE"
                FOUND_SECRETS=1
              fi
            fi
          done
          
          # Check HTML files for API keys
          for file in ui/popup.html; do
            if [ ! -f "$file" ]; then
              continue
            fi
            
            # Only check for very long API key patterns in HTML
            if grep -qE "sk-(proj-)?[a-zA-Z0-9]{48,}" "$file" 2>/dev/null; then
              LINE=$(grep -E "sk-(proj-)?[a-zA-Z0-9]{48,}" "$file" | head -1)
              if echo "$LINE" | grep -qvE "(<!--|-->|example|sample|test|TODO|FIXME)"; then
                echo "Error: Potential API key found in $file"
                echo "Line: $LINE"
                FOUND_SECRETS=1
              fi
            fi
          done
          
          if [ $FOUND_SECRETS -eq 0 ]; then
            echo "✓ No sensitive data detected in code files"
          else
            echo "::error::Sensitive data detected. Please remove API keys from code."
            exit 1
          fi

  build:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create extension package
        run: |
          # Create a ZIP file to verify all files are present
          zip -r leetsimplify-check.zip . -x "*.git*" -x "*.md" -x ".github/*" -x "*.zip"
          ls -lh leetsimplify-check.zip
          echo "✓ Extension package created successfully"
      
      - name: Verify package contents
        run: |
          unzip -l leetsimplify-check.zip | grep -E "(manifest.json|content.js|providers.js)" || exit 1
          echo "✓ Package contains required files"

